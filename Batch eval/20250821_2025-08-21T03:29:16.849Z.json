{"createdAt":"2025-08-15T14:13:32.731Z","updatedAt":"2025-08-21T03:29:16.849Z","id":"XfWoECnQ8VnCPetc","name":"Batch eval","active":true,"isArchived":false,"nodes":[{"parameters":{"mode":"raw","jsonOutput":"{\n\t\"servering_host\": \"10.18.8.120\",\n\t\"servering_port\": 30080,\n\t\"concurrent\": 8,\n    \"cluster\": \"pek\",\n    \"meshy-latv\": 12,\n    \"meshy-latv-decoder\": 2,\n    \"meshy-meshkit-4x\": 2,\n    \"meshy-rf-to-tex\": 5,\n    \"meshy-control-net-plus\": 6,\n    \"meshy-texture-misc-gpu-2x\": 3,\n    \"meshy-holes-8x\": 2,\n    \"meshy-latv-decoder50\": 2,\n    \"meshy-latv50\": 10,\n    \"channel\": \"C09B5U3ETJ5\"\n}","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-680,-20],"id":"7e163028-b60e-4047-a355-7aa037a2af59","name":"Args"},{"parameters":{"authentication":"privateKey","command":"=source /home/runner/muse/batch_eval/.venv/bin/activate\npython3 img3d_batch.py -i /home/runner/batch-output/output_20250811_170752 --texture --serving-host {{ $('Args').item.json.servering_host }} --serving-port {{ $('Args').item.json.servering_port }} --concurrent-jobs {{ $('Args').item.json.concurrent }}","cwd":"/home/runner/muse/batch_eval"},"type":"n8n-nodes-base.ssh","typeVersion":1,"position":[1140,-20],"id":"e375cca1-6870-43a7-9a7d-722d31676f87","name":"texture5.1","credentials":{"sshPrivateKey":{"id":"hbQ0SL5G07trSaPf","name":"runner@n8n-runner"}}},{"parameters":{"authentication":"privateKey","command":"=#!/bin/bash\n\n# 激活虚拟环境\nsource /home/runner/venv/bin/activate\n\n# 设置变量\nCLUSTER=\"{{ $('Args').item.json.cluster }}\"\nAPP=\"meshy\"\nAPP_VERSION=\"{{ $('form-submission').item.json.app_version }}\"\nDEPLOY_SCRIPT=\"/home/runner/meshy-toolkit/k8s/deploy\"\n\n# 检查必要参数\nif [[ -z \"$CLUSTER\" || -z \"$APP_VERSION\" ]]; then\n    echo \"错误: 缺少必要参数\"\n    echo \"CLUSTER: $CLUSTER\"\n    echo \"APP_VERSION: $APP_VERSION\"\n    exit 1\nfi\n\necho \"开始部署...\"\necho \"集群: $CLUSTER\"\necho \"应用: $APP\"\necho \"版本: $APP_VERSION\"\n\n# 第一步：更新应用版本\necho \"步骤1: 更新应用版本...\"\nif $DEPLOY_SCRIPT deploy --environ \"$CLUSTER\" --app \"$APP\" --app-version \"$APP_VERSION\"; then\n    echo \"✅ 版本更新成功\"\nelse\n    echo \"❌ 版本更新失败\"\n    exit 1\nfi\n\n# 第二步：执行部署\necho \"步骤2: 执行部署...\"\nif $DEPLOY_SCRIPT --environ \"$CLUSTER\" --app \"$APP\" deploy; then\n    echo \"✅ 部署成功完成\"\nelse\n    echo \"❌ 部署失败\"\n    exit 1\nfi\n\necho \"🎉 所有操作完成\"","cwd":"/home/runner/meshy-toolkit"},"type":"n8n-nodes-base.ssh","typeVersion":1,"position":[-180,-20],"id":"7772c553-9c62-4f9d-bfb7-98d20e5da440","name":"deploy serving version","credentials":{"sshPrivateKey":{"id":"hbQ0SL5G07trSaPf","name":"runner@n8n-runner"}}},{"parameters":{"authentication":"privateKey","command":"=export KUBECONFIG=/home/runner/meshy-toolkit/k8s/environ/{{ $('Args').item.json.cluster }}/kubeconfig.yaml\n\n# 获取所有使用 GPU 的部署名称\ngpu_deployments=$(kubectl get deployments -n meshyd -o jsonpath='{range .items[?(@.spec.template.spec.containers[*].resources.requests.\"nvidia\\.com/gpu\")]}{.metadata.name}{\"\\n\"}{end}')\n\n# 遍历 GPU 部署并缩容到 0\nfor deploy_name in $gpu_deployments; do\n    if [ ! -z \"$deploy_name\" ]; then\n        current_replicas=$(kubectl get deployment \"$deploy_name\" -n meshyd -o jsonpath='{.spec.replicas}')\n        echo \"Scaling down GPU deployment $deploy_name to 0 from $current_replicas\"\n        kubectl -n meshyd scale deployment \"$deploy_name\" --replicas=0\n    fi\ndone","cwd":"/home/runner/meshy-toolkit"},"type":"n8n-nodes-base.ssh","typeVersion":1,"position":[40,-20],"id":"2ab9953a-1a9f-4742-90db-72285bb88b0a","name":"draft scale down","credentials":{"sshPrivateKey":{"id":"hbQ0SL5G07trSaPf","name":"runner@n8n-runner"}}},{"parameters":{"authentication":"privateKey","command":"=export KUBECONFIG=/home/runner/meshy-toolkit/k8s/environ/{{ $('Args').item.json.cluster }}/kubeconfig.yaml\n\necho \"🚀 扩容部署 - 版本: {{ $('form-submission').item.json.draft }},{{ $('form-submission').item.json.app_version }},{{ $('Args').item.json.cluster }}\"\n\nif [ {{ $('form-submission').item.json.draft }} == meshy-5.1 ]; then\n    kubectl -n meshyd scale deployment meshy-latv --replicas={{ $('Args').item.json['meshy-latv'] }}\n    kubectl -n meshyd scale deployment meshy-latv-decoder --replicas={{ $('Args').item.json['meshy-latv-decoder'] }}\n    kubectl -n meshyd scale deployment meshy-meshkit-4x --replicas={{ $('Args').item.json['meshy-meshkit-4x'] }}\n    echo \"✅ meshy-5.1 部署扩容完成\"\nelif [ {{ $('form-submission').item.json.draft }} == meshy-5.0 ]; then\n    # 添加你的 meshy-5.0 配置\n    echo \"✅ meshy-5.0 部署扩容完成\"\nelse\n    echo \"⚠️  未知版本，跳过扩容\"\nfi","cwd":"/home/runner/meshy-toolkit"},"type":"n8n-nodes-base.ssh","typeVersion":1,"position":[220,-20],"id":"80bf9f23-a4e0-4b68-9f87-9211999d3de0","name":"draft scale up","credentials":{"sshPrivateKey":{"id":"hbQ0SL5G07trSaPf","name":"runner@n8n-runner"}}},{"parameters":{"authentication":"privateKey","command":"=source /home/runner/muse/batch_eval/.venv/bin/activate\npython3 img3d_batch.py -i /home/runner/muse/batch-output/assets/{{ $('form-submission').item.json.assets }} -o output --serving-host {{ $('Args').item.json.servering_host }} --serving-port {{ $('Args').item.json.servering_port }} --models {{ $('form-submission').item.json.draft }}","cwd":"/home/runner/muse/batch_eval/"},"type":"n8n-nodes-base.ssh","typeVersion":1,"position":[440,-20],"id":"e54098e6-bdac-4f1b-94fb-f56f1459345d","name":"draft","credentials":{"sshPrivateKey":{"id":"hbQ0SL5G07trSaPf","name":"runner@n8n-runner"}}},{"parameters":{"authentication":"privateKey","command":"=export KUBECONFIG=/home/runner/meshy-toolkit/k8s/environ/{{ $('Args').item.json.cluster }}/kubeconfig.yaml\n\n# 获取所有使用 GPU 的部署名称\ngpu_deployments=$(kubectl get deployments -n meshyd -o jsonpath='{range .items[?(@.spec.template.spec.containers[*].resources.requests.\"nvidia\\.com/gpu\")]}{.metadata.name}{\"\\n\"}{end}')\n\n# 遍历 GPU 部署并缩容到 0\nfor deploy_name in $gpu_deployments; do\n    if [ ! -z \"$deploy_name\" ]; then\n        current_replicas=$(kubectl get deployment \"$deploy_name\" -n meshyd -o jsonpath='{.spec.replicas}')\n        echo \"Scaling down GPU deployment $deploy_name to 0 from $current_replicas\"\n        kubectl -n meshyd scale deployment \"$deploy_name\" --replicas=0\n    fi\ndone","cwd":"/home/runner/meshy-toolkit"},"type":"n8n-nodes-base.ssh","typeVersion":1,"position":[660,-20],"id":"846d9632-76d1-48cb-9358-68d70b816284","name":"texture scale down","credentials":{"sshPrivateKey":{"id":"hbQ0SL5G07trSaPf","name":"runner@n8n-runner"}}},{"parameters":{"authentication":"privateKey","command":"=echo \"🚀 扩容部署 - 版本: {{ $('form-submission').item.json.draft }}{{ $('form-submission').item.json.app_version }}\"\n\nif [ {{ $('form-submission').item.json.draft }} == meshy-5.1 ]; then\n    echo \"扩容 meshy-rf-to-tex...\"\n    kubectl -n meshyd scale deployment meshy-rf-to-tex --replicas={{ $('Args').item.json['meshy-rf-to-tex'] }}\n    \n    echo \"扩容 meshy-control-net-plus...\"\n    kubectl -n meshyd scale deployment meshy-control-net-plus --replicas=\n{{ $('Args').item.json['meshy-control-net-plus'] }}    \n    echo \"扩容 meshy-texture-misc-gpu-2x...\"\n    kubectl -n meshyd scale deployment meshy-texture-misc-gpu-2x --replicas={{ $('Args').item.json['meshy-texture-misc-gpu-2x'] }}\n    \n    echo \"扩容 meshy-latv-decoder...\"\n    kubectl -n meshyd scale deployment meshy-latv-decoder --replicas={{ $('Args').item.json['meshy-latv-decoder50'] }}\n    \n    echo \"✅ meshy-5.1 部署扩容完成\"\n    \nelif [ {{ $('form-submission').item.json.draft }} == meshy-5.0 ]; then\n    echo \"🚀 扩容 meshy-5.0 部署...\"\n    echo \"✅ meshy-5.0 部署扩容完成\"\n    \nelse\n    echo \"⚠️  未知版本，跳过扩容\"\nfi","cwd":"/home/runner/meshy-toolkit"},"type":"n8n-nodes-base.ssh","typeVersion":1,"position":[880,-20],"id":"ea572e13-827e-4f8f-989a-1979f454a781","name":"texture scale up","credentials":{"sshPrivateKey":{"id":"hbQ0SL5G07trSaPf","name":"runner@n8n-runner"}}},{"parameters":{"select":"channel","channelId":{"__rl":true,"value":"={{ $('Args').item.json.channel }}","mode":"id"},"messageType":"attachment","attachments":[{"text":"=�� 评测任务执行成功！  �� 部署信息: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ \n• Serving 版本: `{{ $('form-submission').item.json.app_version }}` \n• 应用名称: `meshy {{ $('form-submission').item.json.app_version }}` \n• 算法版本: `{{ $('form-submission').item.json.draft }}` \n• 目标环境: `{{ $('form-submission').item.json.draft }}`  \n⚙️ 评测参数: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ \n• 并发任务数: `{{ $('Args').item.json.concurrent }}` \n• 模型类型: ``  \n�� 结果信息: ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ \n• 输出目录: `` \n• 结果地址: `{{ $('form-submission').item.json.draft }}:{{ $('Args').item.json.servering_port }}` \n• 任务状态: ✅ 成功完成 \n⏰ 执行时间: {{ $now.format('YYYY-MM-DD HH:mm:ss') }}"}],"otherOptions":{"includeLinkToWorkflow":false}},"type":"n8n-nodes-base.slack","typeVersion":2.3,"position":[1380,-20],"id":"07e87ef5-1702-4d65-a264-019c000525da","name":"Send finish","webhookId":"2eb65517-dd80-4385-941a-52c1944b8718","credentials":{"slackApi":{"id":"iLK9eOc0lWWlxZZW","name":"Slack Meshy Bot"}}},{"parameters":{"formTitle":"batch_eval","formFields":{"values":[{"fieldLabel":"version","placeholder":"serving version","requiredField":true},{"fieldLabel":"draft","placeholder":"meshy-5 / meshy-5.1","requiredField":true},{"fieldLabel":"assets","placeholder":"PBR_Eval_20250722/Quick37_20250728","requiredField":true}]},"responseMode":"lastNode","options":{"path":"batch_eval"}},"type":"n8n-nodes-base.formTrigger","typeVersion":2.2,"position":[-920,-20],"id":"313a8c24-6faf-4135-884d-1042c847ddff","name":"form-submission","webhookId":"be745a25-c67c-46b2-8e36-9e5dbd76968f"}],"connections":{"Args":{"main":[[{"node":"deploy serving version","type":"main","index":0}]]},"deploy serving version":{"main":[[{"node":"draft scale down","type":"main","index":0}]]},"draft scale down":{"main":[[{"node":"draft scale up","type":"main","index":0}]]},"draft scale up":{"main":[[{"node":"draft","type":"main","index":0}]]},"draft":{"main":[[{"node":"texture scale down","type":"main","index":0}]]},"texture scale down":{"main":[[{"node":"texture scale up","type":"main","index":0}]]},"texture scale up":{"main":[[{"node":"texture5.1","type":"main","index":0}]]},"texture5.1":{"main":[[{"node":"Send finish","type":"main","index":0}]]},"form-submission":{"main":[[{"node":"Args","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"form-submission":[{"json":{"draft":"meshy-5.1","app_version":"304c7bf","assets":"PBR_Eval_20250722"}}]},"versionId":"a3a11028-b213-4711-8ca5-48b0d4b5e44f","triggerCount":1,"shared":[{"createdAt":"2025-08-15T14:13:32.731Z","updatedAt":"2025-08-15T14:13:32.731Z","role":"workflow:owner","workflowId":"XfWoECnQ8VnCPetc","projectId":"jA0J1Ydudz3t9Nad","project":{"createdAt":"2025-06-26T09:34:51.351Z","updatedAt":"2025-06-26T09:37:01.737Z","id":"jA0J1Ydudz3t9Nad","name":"Meshy AI <cloud-admins@meshy.ai>","type":"personal","icon":null,"description":null,"projectRelations":[{"createdAt":"2025-06-26T09:34:51.351Z","updatedAt":"2025-06-26T09:34:51.351Z","role":"project:personalOwner","userId":"35043bb3-1b78-4ddc-8eb1-4498c37e073f","projectId":"jA0J1Ydudz3t9Nad","user":{"createdAt":"2025-06-26T09:34:50.409Z","updatedAt":"2025-07-08T09:36:34.003Z","id":"35043bb3-1b78-4ddc-8eb1-4498c37e073f","email":"cloud-admins@meshy.ai","firstName":"Meshy","lastName":"AI","personalizationAnswers":null,"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"5wCVdXpCNTB9yu66","userActivatedAt":1751967393973},"role":"global:owner","disabled":false,"mfaEnabled":false,"isPending":false}}]}}],"tags":[]}